<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер та Менеджер Документів</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, #0f172a, #020617);
            color: #e5e7eb;
        }

        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .drop-zone:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.15);
        }

        .drop-zone.drag-over {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.15);
        }

        .field-zone {
            border: 2px dashed rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.04);
            transition: all 0.3s ease;
        }

        .field-zone:not(.has-file):hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .field-zone.has-file {
            border-style: solid;
            border-color: #34d399;
            background: rgba(16, 185, 129, 0.12);
        }

        .scrollable-preview::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-preview::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        .scrollable-preview::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.35);
            border-radius: 10px;
        }

        .file-card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
        }

        #previewModal {
            background: rgba(2, 6, 23, 0.9);
        }

        input {
            background: rgba(255, 255, 255, 0.08) !important;
            color: #e5e7eb !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        input::placeholder {
            color: #9ca3af;
        }

        #previewContent canvas {
            max-width: 100%; 
            height: auto;
        }
    </style>
</head>
<body>

<div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <header class="mb-10">
        <h1 class="text-4xl font-extrabold text-white border-b pb-2 border-blue-500">Конвертер та Менеджер Документів</h1>
        <p class="text-white mt-2 text-lg">Створіть професійний пакет документів: завантаження, об'єднання та організація.</p>
    </header>

    <div class="glass p-6 rounded-xl mb-8 border-t-4 border-blue-500">
        <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
            <div class="flex-grow">
                <label for="internalCode" class="block text-sm font-semibold text-white">Внутрішній код (Обов'язково для назви файлів)</label>
                <input type="text" id="internalCode" placeholder="Наприклад: 00-00004117" 
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-inner focus:border-blue-500 focus:ring-blue-500 p-3 border transition duration-150"
                        oninput="updateDownloadButtonState()">
            </div>
            
            <button onclick="handleZipDownload()" id="downloadZipBtn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl hover:shadow-2xl transition duration-200 transform hover:scale-[1.02] disabled:opacity-50" disabled>
                <span id="downloadText">Завантажити ZIP-Пакет</span>
            </button>
            
            <button onclick="handleClearAll()" 
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.01]">
                Очистити все
            </button>
        </div>
    </div>

    <div id="dropZone" class="drop-zone p-12 text-center cursor-pointer mb-8 glass p-8 rounded-xl transition duration-200 shadow-md"
            onclick="document.getElementById('fileInput').click()"
            ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
        <svg class="mx-auto h-16 w-16 text-white-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <p class="mt-2 text-lg text-white-700 font-semibold">Перетягніть файли сюди або <span class="text-blue-600 hover:text-blue-800 transition duration-150">натисніть для вибору</span></p>
        <p class="text-sm text-white-500 mt-1">Підтримуються: .jpg, .png, .pdf, .doc, .docx та інші.</p>
        <input type="file" id="fileInput" multiple accept="*/*" onchange="handleFileUpload(this.files)" class="hidden">
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-2 glass p-8 rounded-xl">
            <h2 class="text-2xl font-bold mb-6 text-white-800 border-b pb-3">Завантажені файли (<span id="fileCount">0</span>)</h2>
            
            <div id="mergeControls" class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-3 sm:space-y-0 mb-6">
                <div id="imageMergeControls" class="flex items-center space-x-2" style="display:none;">
                    <button onclick="handleImageMerge()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-[1.01] transition duration-200 disabled:opacity-50" id="imageMergeBtn" disabled>
                        Об'єднати зображення у PDF
                    </button>
                    <span class="text-xs text-white-500">(Виберіть 1+ зображення)</span>
                </div>

                <div id="pdfMergeControls" class="flex items-center space-x-2" style="display:none;">
                    <button onclick="handlePdfMerge()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-[1.01] transition duration-200 disabled:opacity-50" id="pdfMergeBtn" disabled>
                        Об'єднати PDF-файли
                    </button>
                    <span class="text-xs text-white-500">(Виберіть 2+ PDF)</span>
                </div>
            </div>
            
            <div id="fileList" class="min-h-[200px] border-2 border-gray-100 rounded-xl p-4 scrollable-preview max-h-[60vh] overflow-y-auto space-y-3">
                <p id="emptyMessage" class="text-white-400 text-center py-10">Файли ще не завантажені.</p>
            </div>
        </div>

        <div class="glass p-8 rounded-xl">
            <h2 class="text-2xl font-bold mb-6 text-white-800 border-b pb-3">Прив'язка до полів</h2>
            <div id="bindingFields" class="space-y-6">
                <div id="field_manual" data-key="manual" data-label="Інструкція" 
                    class="field-zone p-4 rounded-lg min-h-[100px]"
                    ondragover="handleFieldDragOver(event)" ondragleave="handleFieldDragLeave(event)" ondrop="handleFieldDrop(event)">
                    <p class="font-semibold text-white-700 flex justify-between items-center">
                        Інструкція <span id="manualFileName" class="text-sm font-normal text-green-700"></span>
                    </p>
                    <p class="text-sm text-white-500 mt-1">Перетягніть файл інструкції сюди.</p>
                    <button id="manualRemoveBtn" onclick="removeBoundFile('manual')" class="text-red-500 text-xs hidden mt-2 hover:text-red-700 font-medium">Видалити прив'язку</button>
                </div>

                <div id="field_specs" data-key="specs" data-label="Технічні характеристики" 
                    class="field-zone p-4 rounded-lg min-h-[100px]"
                    ondragover="handleFieldDragOver(event)" ondragleave="handleFieldDragLeave(event)" ondrop="handleFieldDrop(event)">
                    <p class="font-semibold text-white-700 flex justify-between items-center">
                        Технічні характеристики <span id="specsFileName" class="text-sm font-normal text-green-700"></span>
                    </p>
                    <p class="text-sm text-white-500 mt-1">Перетягніть файл тех. характеристик сюди.</p>
                    <button id="specsRemoveBtn" onclick="removeBoundFile('specs')" class="text-red-500 text-xs hidden mt-2 hover:text-red-700 font-medium">Видалити прив'язку</button>
                </div>

                <div id="field_certificate" data-key="certificate" data-label="Сертифікат" 
                    class="field-zone p-4 rounded-lg min-h-[100px]"
                    ondragover="handleFieldDragOver(event)" ondragleave="handleFieldDragLeave(event)" ondrop="handleFieldDrop(event)">
                    <p class="font-semibold text-white-700 flex justify-between items-center">
                        Сертифікат <span id="certificateFileName" class="text-sm font-normal text-green-700"></span>
                    </p>
                    <p class="text-sm text-white-200 mt-1">Перетягніть файл сертифікату сюди.</p>
                    <button id="certificateRemoveBtn" onclick="removeBoundFile('certificate')" class="text-red-500 text-xs hidden mt-2 hover:text-red-700 font-medium">Видалити прив'язку</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="previewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50" onclick="closePreviewModal()">
    <div class="glass p-8 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center border-b p-4">
            <h3 id="previewTitle" class="text-lg font-semibold text-white-800">Попередній перегляд</h3>
            <button onclick="closePreviewModal()" class="text-white-400 hover:text-white-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="previewContent" class="p-4 max-h-[80vh] overflow-y-auto flex flex-col items-center"> 
        </div>
    </div>
</div>

<div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-xl shadow-xl z-[100] transition-opacity duration-300 hidden opacity-0" role="alert">
    <p id="messageText"></p>
</div>


<script>

    let uploadedFiles = [];
    let boundFiles = {}; 
    let nextFileId = 1;
    
    const fileListEl = document.getElementById('fileList');
    const dropZoneEl = document.getElementById('dropZone');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const imageMergeControlsEl = document.getElementById('imageMergeControls');
    const pdfMergeControlsEl = document.getElementById('pdfMergeControls');
    const previewModalEl = document.getElementById('previewModal');

    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }

    function showMessage(text, duration = 3000) {
        const box = document.getElementById('messageBox');
        const textEl = document.getElementById('messageText');
        
        textEl.textContent = text;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.remove('opacity-0'), 10); 
        
        setTimeout(() => {
            box.classList.add('opacity-0');
            setTimeout(() => box.classList.add('hidden'), 300); 
        }, duration);
    }
    
    function getFileIcon(mimeType) {
        const baseClass = "w-8 h-8";
        if (mimeType.startsWith('image/')) return `<svg class="${baseClass} text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
        
        if (mimeType === 'application/pdf') return `<svg class="${baseClass} text-red-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H8c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 15h-2v-2h2v2zm0-4h-2V9h-2V7h4v6zm-4-10H8v16h8V8l-4-4z"/></svg>`;
        
        if (mimeType.includes('officedocument') || mimeType.includes('word')) return `<svg class="${baseClass} text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm1 14H8v-2h5v2zm3-4H8v-2h8v2zm0-4H8V7h8v2z"></path></svg>`;

        return `<svg class="${baseClass} text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`;
    }

    function isImage(fileObject) {
        return fileObject.type.startsWith('image/');
    }

    function isPdf(fileObject) {
        return fileObject.type === 'application/pdf';
    }
    
    function updateDownloadButtonState() {
        const code = document.getElementById('internalCode').value.trim();
        const hasBoundFiles = Object.keys(boundFiles).some(key => boundFiles[key]);
        downloadZipBtn.disabled = !code || !hasBoundFiles;
    }

    function renderFileList() {
        const hasImages = uploadedFiles.some(isImage);
        const hasPdfs = uploadedFiles.some(isPdf);
        
        imageMergeControlsEl.style.display = hasImages ? 'flex' : 'none';
        pdfMergeControlsEl.style.display = hasPdfs ? 'flex' : 'none';

        const fileListHTML = uploadedFiles.map(file => {
            const isImg = isImage(file);
            const isPDF = isPdf(file);
            const isSelectable = isImg || isPDF;
            const isBound = Object.values(boundFiles).includes(file.id);
            const draggable = !isBound ? 'draggable="true"' : '';
            const opacity = isBound ? 'opacity-60 cursor-not-allowed' : 'cursor-grab';
            
            return `
                <div id="file-${file.id}" 
                    data-file-id="${file.id}" 
                    data-file-type="${isImg ? 'image' : (isPDF ? 'pdf' : 'other')}"
                    class="flex items-center space-x-3 p-3 bg-gray-50 rounded-xl shadow-sm hover:bg-gray-100 ${opacity} transition duration-100 border border-gray-100"
                    ${draggable}
                    ondragstart="handleDragStart(event, ${file.id})"
                    ondragend="handleDragEnd(event)">
                    
                    <!-- Чекбокс тільки для зображень/PDF -->
                    ${isSelectable ? `<input type="checkbox" id="check-${file.id}" data-file-id="${file.id}" onchange="checkMergeControls()" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">` : '<span class="w-4 h-4"></span>'}
                    
                    ${getFileIcon(file.type)}
                    
                    <div class="flex-grow min-w-0">
                        <p class="text-sm font-medium text-gray-800 truncate" title="${file.name}">${file.name}</p>
                        <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    
                    <button onclick="openPreviewModal(${file.id})" 
                            class="text-blue-500 hover:text-blue-700 text-sm font-medium transition duration-150">
                        Прев'ю
                    </button>
                    
                    <button onclick="removeFile(${file.id})" 
                            class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded hover:bg-red-50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
        }).join('');

        fileListEl.innerHTML = fileListHTML || '<p id="emptyMessage" class="text-gray-400 text-center py-10">Файли ще не завантажені.</p>';
        document.getElementById('fileCount').textContent = uploadedFiles.length;
        
        checkMergeControls();
        updateDownloadButtonState();
    }
    
    function checkMergeControls() {
        const checkboxes = Array.from(document.querySelectorAll('#fileList input[type="checkbox"]'));
        
        const selectedImages = checkboxes.filter(cb => cb.checked && uploadedFiles.find(f => f.id === parseInt(cb.dataset.fileId) && isImage(f)));
        const selectedPdfs = checkboxes.filter(cb => cb.checked && uploadedFiles.find(f => f.id === parseInt(cb.dataset.fileId) && isPdf(f)));
        
        document.getElementById('imageMergeBtn').disabled = selectedImages.length < 1;
        document.getElementById('pdfMergeBtn').disabled = selectedPdfs.length < 2;
    }

    function removeFile(fileId) {
        uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
        
        Object.keys(boundFiles).forEach(key => {
            if (boundFiles[key] === fileId) {
                boundFiles[key] = null;
            }
        });
        
        renderBoundFields();
        renderFileList();
        showMessage('Файл успішно видалено.', 2000);
    }

    function renderBoundFields() {
        ['manual', 'specs', 'certificate'].forEach(key => {
            const fieldEl = document.getElementById(`field_${key}`);
            const fileNameEl = document.getElementById(`${key}FileName`);
            const removeBtnEl = document.getElementById(`${key}RemoveBtn`);
            
            fieldEl.classList.remove('has-file');
            fileNameEl.textContent = '';
            removeBtnEl.classList.add('hidden');

            if (boundFiles[key]) {
                const file = uploadedFiles.find(f => f.id === boundFiles[key]);
                if (file) {
                    fieldEl.classList.add('has-file');
                    fileNameEl.textContent = `(Файл: ${file.name})`;
                    removeBtnEl.classList.remove('hidden');
                } else {
                    boundFiles[key] = null;
                }
            }
        });
        renderFileList();
    }

    function handleFileUpload(files) {
        Array.from(files).forEach(file => {
            uploadedFiles.push({
                id: nextFileId++,
                name: file.name,
                type: file.type || 'application/octet-stream',
                size: file.size,
                file: file,
            });
        });
        renderFileList();
    }

    function handleDragOver(e) {
        e.preventDefault();
        dropZoneEl.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dropZoneEl.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        dropZoneEl.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
            handleFileUpload(e.dataTransfer.files);
        }
    }

    let draggedFileId = null;

    function handleDragStart(e, fileId) {
        draggedFileId = fileId;
        e.dataTransfer.setData('text/plain', fileId);
        e.currentTarget.classList.add('opacity-50', 'border-2', 'border-blue-500');
    }

    function handleDragEnd(e) {
        draggedFileId = null;
        e.currentTarget.classList.remove('opacity-50', 'border-2', 'border-blue-500');
    }

    function handleFieldDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('bg-blue-100', 'border-blue-500', 'border-solid');
    }

    function handleFieldDragLeave(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('bg-blue-100', 'border-blue-500', 'border-solid');
    }

    function handleFieldDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('bg-blue-100', 'border-blue-500', 'border-solid');
        
        const fileId = draggedFileId;
        const fieldKey = e.currentTarget.dataset.key;

        if (fileId && fieldKey) {
            for (const key in boundFiles) {
                if (boundFiles[key] === fileId) {
                    boundFiles[key] = null; 
                }
            }
            
            boundFiles[fieldKey] = parseInt(fileId);
            renderBoundFields();
            showMessage(`Файл прив'язано до поля "${e.currentTarget.dataset.label}".`, 2500);
        }
    }

    function removeBoundFile(key) {
        const fieldEl = document.getElementById(`field_${key}`);
        const fieldLabel = fieldEl ? fieldEl.dataset.label : key;
        boundFiles[key] = null;
        renderBoundFields();
        showMessage(`Прив'язку видалено з поля "${fieldLabel}".`, 2500);
    }
    
    async function renderPdfToCanvas(pdfBlob, containerEl) {
        containerEl.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto"></div><p class="text-gray-600 mt-2">Завантаження PDF...</p></div>';
        
        if (!window.pdfjsLib) {
             containerEl.innerHTML = `<div class="text-center p-8 bg-gray-100 rounded-lg"><p class="text-lg font-medium text-red-700">Помилка: Бібліотека pdf.js не завантажена.</p></div>`;
             return;
        }

        const arrayBuffer = await pdfBlob.arrayBuffer();
        
        try {
            const pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            containerEl.innerHTML = '';

            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const page = await pdfDocument.getPage(i);
                
                const viewport = page.getViewport({ scale: 1 });
                const desiredWidth = 850; 
                const scale = desiredWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                const canvas = document.createElement('canvas');
                const canvasContext = canvas.getContext('2d');
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;
                canvas.className = 'my-4 border border-gray-200 rounded-lg shadow-md';

                const pageContainer = document.createElement('div');
                pageContainer.className = 'flex flex-col mb-6 w-full'; 
                pageContainer.innerHTML = `<p class="text-xs text-gray-500 mb-1 text-center">Сторінка ${i}</p>`;
                pageContainer.appendChild(canvas);
                
                containerEl.appendChild(pageContainer);

                const renderContext = {
                    canvasContext,
                    viewport: scaledViewport
                };
                await page.render(renderContext).promise;
            }
            
        } catch (error) {
            console.error("Помилка рендерингу PDF:", error);
            containerEl.innerHTML = `<div class="text-center p-8 bg-red-50 rounded-lg"><p class="text-lg font-medium text-red-700">Не вдалося відобразити PDF.</p><p class="text-sm text-gray-500 mt-2">Деталі: ${error.message}</p></div>`;
        }
    }

    function openPreviewModal(fileId) {
        const file = uploadedFiles.find(f => f.id === fileId);
        if (!file) return showMessage('Помилка: Файл не знайдено.', 3000);

        document.getElementById('previewTitle').textContent = `Попередній перегляд: ${file.name}`;
        const contentEl = document.getElementById('previewContent');
        contentEl.innerHTML = '';
        
        if (!file.file) {
            contentEl.innerHTML = `<div class="text-center p-8 bg-gray-100 rounded-lg"><p class="text-lg font-medium text-gray-700">Помилка: Відсутні дані файлу.</p></div>`;
        } else if (isImage(file)) {
            const imgUrl = URL.createObjectURL(file.file);
            contentEl.innerHTML = `<img src="${imgUrl}" alt="${file.name}" class="max-w-full h-auto rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/400x300/e0e0e0/333?text=Помилка+завантаження+зображення';">`;
        } else if (isPdf(file)) {
            renderPdfToCanvas(file.file, contentEl);
        } else {
            contentEl.innerHTML = `
                <div class="text-center p-8 bg-gray-100 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">Попередній перегляд не підтримується для цього формату.</p>
                    <p class="text-sm text-gray-500 mt-2">Тип файлу: ${file.type}</p>
                    <p class="text-sm text-gray-500">Розмір: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            `;
        }

        previewModalEl.classList.remove('hidden');
        previewModalEl.classList.add('flex');
    }

    function closePreviewModal() {
        previewModalEl.classList.add('hidden');
        previewModalEl.classList.remove('flex');
        
        const contentEl = document.getElementById('previewContent');
        
        const img = contentEl.querySelector('img');
        if (img && img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
        
        contentEl.innerHTML = ''; 
    }
    
    async function handlePdfMerge() {
        if (!window.PDFLib) return showMessage('Помилка: Бібліотека PDFLib не завантажена.', 5000);
        
        const selectedPdfIds = Array.from(document.querySelectorAll('#fileList input[type="checkbox"]'))
            .filter(cb => cb.checked && uploadedFiles.find(f => f.id === parseInt(cb.dataset.fileId) && isPdf(f)))
            .map(cb => parseInt(cb.dataset.fileId));
            
        if (selectedPdfIds.length < 2) {
            showMessage('Будь ласка, виберіть мінімум два PDF-файли для об\'єднання.', 4000);
            return;
        }

        const pdfsToMerge = selectedPdfIds.map(id => uploadedFiles.find(f => f.id === id)).filter(Boolean);

        const originalBtnText = document.getElementById('pdfMergeBtn').textContent;
        document.getElementById('pdfMergeBtn').textContent = 'Обробка...';
        document.getElementById('pdfMergeBtn').disabled = true;

        const newPdfDoc = await PDFLib.PDFDocument.create();
        let mergeSuccess = true;

        for (const file of pdfsToMerge) {
            try {
                const pdfBytes = await file.file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                copiedPages.forEach((page) => newPdfDoc.addPage(page));

            } catch (error) {
                console.error("Помилка при обробці PDF:", file.name, error);
                mergeSuccess = false;
                showMessage(`Помилка при обробці файлу ${file.name}. Об'єднання скасовано.`, 6000);
                break;
            }
        }
        
        document.getElementById('pdfMergeBtn').textContent = originalBtnText;
        document.getElementById('pdfMergeBtn').disabled = false;

        if (!mergeSuccess) return;
        
        const mergedPdfBytes = await newPdfDoc.save();
        const mergedPdfBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const newFileName = `merged_${new Date().toISOString().slice(0, 10)}.pdf`;
        
        uploadedFiles.push({
            id: nextFileId++,
            name: newFileName,
            type: 'application/pdf',
            size: mergedPdfBlob.size,
            file: mergedPdfBlob,
        });

        uploadedFiles = uploadedFiles.filter(f => !selectedPdfIds.includes(f.id));
        
        Object.keys(boundFiles).forEach(key => {
            if (selectedPdfIds.includes(boundFiles[key])) {
                boundFiles[key] = null;
            }
        });

        renderBoundFields();
        renderFileList();
        showMessage(`Успішно об'єднано ${selectedPdfIds.length} PDF-файлів у ${newFileName}!`, 5000);
    }

    async function handleImageMerge() {
        if (!window.jspdf) return showMessage('Помилка: Бібліотека jspdf не завантажена.', 5000);

        const selectedImageIds = Array.from(document.querySelectorAll('#fileList input[type="checkbox"]'))
            .filter(cb => cb.checked && uploadedFiles.find(f => f.id === parseInt(cb.dataset.fileId) && isImage(f)))
            .map(cb => parseInt(cb.dataset.fileId));
        
        if (selectedImageIds.length < 1) {
            showMessage('Будь ласка, виберіть мінімум одне зображення для конвертації.', 4000);
            return;
        }

        const imagesToConvert = selectedImageIds.map(id => uploadedFiles.find(f => f.id === id)).filter(Boolean);

        const originalBtnText = document.getElementById('imageMergeBtn').textContent;
        document.getElementById('imageMergeBtn').textContent = 'Обробка...';
        document.getElementById('imageMergeBtn').disabled = true;

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        pdf.deletePage(1);

        let conversionSuccess = true;

        for (let i = 0; i < imagesToConvert.length; i++) {
            const file = imagesToConvert[i];
            
            try {
                const imgData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file.file);
                });

                const img = new Image();
                await new Promise(resolve => {
                    img.onload = resolve;
                    img.src = imgData;
                });

                const imgWidth = img.width;
                const imgHeight = img.height;
                const format = imgData.split(';')[0].split('/')[1] || 'jpeg';
                
                const pdfWidth = 595.28; 
                let pdfHeight = (imgHeight * pdfWidth) / imgWidth;

                pdf.addPage([pdfWidth, pdfHeight], pdfWidth > pdfHeight ? 'l' : 'p'); 

                pdf.addImage(imgData, format, 0, 0, pdfWidth, pdfHeight);

            } catch (error) {
                console.error("Помилка конвертації зображення:", file.name, error);
                conversionSuccess = false;
                showMessage(`Помилка при обробці файлу ${file.name}. Конвертація скасована.`, 6000);
                break;
            }
        }
        
        document.getElementById('imageMergeBtn').textContent = originalBtnText;
        document.getElementById('imageMergeBtn').disabled = false;

        if (!conversionSuccess) return;

        const pdfBlob = pdf.output('blob');

        const newFileName = `images_${new Date().toISOString().slice(0, 10)}.pdf`;
        
        uploadedFiles.push({
            id: nextFileId++,
            name: newFileName,
            type: 'application/pdf',
            size: pdfBlob.size,
            file: pdfBlob, 
        });

        uploadedFiles = uploadedFiles.filter(f => !selectedImageIds.includes(f.id));

        Object.keys(boundFiles).forEach(key => {
            if (selectedImageIds.includes(boundFiles[key])) {
                boundFiles[key] = null;
            }
        });

        renderBoundFields();
        renderFileList();
        showMessage(`Успішно конвертовано/об'єднано ${selectedImageIds.length} зображень у ${newFileName}!`, 5000);
    }

    async function handleZipDownload() {
        if (!window.JSZip) return showMessage('Помилка: Бібліотека JSZip не завантажена.', 5000);

        const internalCode = document.getElementById('internalCode').value.trim();
        if (!internalCode) {
            return showMessage('Будь ласка, введіть Внутрішній код.', 3000);
        }

        const filesToZip = [];
        let missingFile = false;

        const fieldMap = {
            'manual': 'Інструкція',
            'specs': 'Технічні характеристики',
            'certificate': 'Сертифікат'
        };
        
        const cleanInternalCode = internalCode.toLowerCase().replace(/[^a-z0-9\-]/g, '-').replace(/-+/g, '-');

        Object.keys(boundFiles).forEach(key => {
            const fileId = boundFiles[key];
            if (fileId) {
                const file = uploadedFiles.find(f => f.id === fileId);
                if (file) {
                    const originalExt = file.name.split('.').pop();
                    const rawLabel = fieldMap[key];
                    const cleanLabel = rawLabel.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-');
                    
                    const newFileName = `${key}-${cleanInternalCode}-${cleanLabel}.${originalExt}`
                                            .toLowerCase()
                                            .replace(/[^a-z0-9\-\.]/g, '_') 
                                            .replace(/__+/g, '_'); 
                    
                    filesToZip.push({ 
                        file: file.file, 
                        name: newFileName 
                    });
                } else {
                    missingFile = true;
                    console.error(`Bound file ID ${fileId} not found in uploadedFiles.`);
                }
            }
        });

        if (missingFile) {
            return showMessage('Помилка: Не вдалося знайти один або кілька прив\'язаних файлів.', 5000);
        }

        if (filesToZip.length === 0) {
            return showMessage('Немає прив\'язаних файлів для завантаження.', 3000);
        }

        const zip = new JSZip();
        filesToZip.forEach(item => {
            zip.file(item.name, item.file);
        });

        document.getElementById('downloadText').textContent = 'Створення ZIP...';
        downloadZipBtn.disabled = true;

        try {
            const zipBlob = await zip.generateAsync({ type: "blob" });
            const zipFileName = `${cleanInternalCode}_package.zip`;
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage(`ZIP-архів ${zipFileName} успішно створено та завантажено.`, 5000);

        } catch (error) {
            console.error("Помилка створення ZIP:", error);
            showMessage('Помилка: Не вдалося створити ZIP-архів.', 5000);
        } finally {
            document.getElementById('downloadText').textContent = 'Завантажити ZIP-Пакет';
            updateDownloadButtonState();
        }
    }

    function handleClearAll() {
        uploadedFiles = [];
        boundFiles = {};
        nextFileId = 1;
        document.getElementById('internalCode').value = '';
        
        renderBoundFields();
        renderFileList();
        
        Array.from(document.querySelectorAll('#fileList input[type="checkbox"]')).forEach(cb => cb.checked = false);
        checkMergeControls();
        
        showMessage('Усі дані очищено.', 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        boundFiles = {
            'manual': null,
            'specs': null,
            'certificate': null,
        };
        renderFileList();
        renderBoundFields();
    });
</script>
</body>
</html>